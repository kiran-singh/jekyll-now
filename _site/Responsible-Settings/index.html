<!DOCTYPE html>
<html>
  <head>
    <title>Responsible Settings – Kiran Singh – Agile Web Developer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="The .Net config settings are usually left to individual teams/developers and mostly tackled by calling a static config manager or a wrapper where the setting is required.

```csharp
// The old way
var timout = int.Parse(ConfigurationManager.AppSettings[“Timeout”]);

" />
    <meta property="og:description" content="The .Net config settings are usually left to individual teams/developers and mostly tackled by calling a static config manager or a wrapper where the setting is required.

```csharp
// The old way
var timout = int.Parse(ConfigurationManager.AppSettings[“Timeout”]);

" />
    
    <meta name="author" content="Kiran Singh" />

    
    <meta property="og:title" content="Responsible Settings" />
    <meta property="twitter:title" content="Responsible Settings" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Kiran Singh - Agile Web Developer" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars3.githubusercontent.com/u/4776194?v=4&s=460" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Kiran Singh</a></h1>
            <p class="site-description">Agile Web Developer</p>
          </div>

          <!-- <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav> -->
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Responsible Settings</h1>

  <div class="entry">
    <p>The .Net config settings are usually left to individual teams/developers and mostly tackled by calling a static config manager or a wrapper where the setting is required.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The old way</span>
<span class="kt">var</span> <span class="n">timout</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"Timeout"</span><span class="p">]);</span>

<span class="c1">// Newer</span>
<span class="kt">var</span> <span class="n">apiId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">_configManager</span><span class="p">.</span><span class="nf">AppSetting</span><span class="p">(</span><span class="s">"ApiId"</span><span class="p">));</span>
</code></pre></div></div>

<p>As shown above, the resulting string value has to be converted to the type of variable if different.</p>

<p>Ideally this manipulation shouldn’t be left to individual classes as they get littered with app setting names, methods to parse the setting values and tackling what to do if any setting is missing or invalid.<br />
There is also the possibility that a setting not required immediately would be missing or misconfigured when the code is deployed to live.</p>

<p>A better way would be a class like the <code class="highlighter-rouge">Settings</code> class in code below that validates the settings and sets them up as needed. <br />
This is for <strong>.Net Core</strong> but similar class can be created for other versions of .Net.</p>

<p>This class can be either injected or preferably just called on startup by the IOC container and the required config value injected into the controller or service that needs them.</p>

<p><strong>The constructor uses reflection to get the names &amp; types of the its class’ properties and throws an exception if any setting is missing or if any of the values are default for the type.</strong><br />
The full code is <a href="https://github.com/kiran-singh/ResponsibleSettings/">here on github</a></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Settings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Settings</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">declaredProperties</span> <span class="p">=</span> 
            <span class="nf">GetType</span><span class="p">().</span><span class="nf">GetTypeInfo</span><span class="p">().</span><span class="n">DeclaredProperties</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">missingSettings</span> <span class="p">=</span> 
            <span class="p">(</span><span class="k">from</span> <span class="n">propertyInfo</span> <span class="k">in</span> <span class="n">declaredProperties</span>
            <span class="k">where</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">])</span>
            <span class="k">select</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">missingSettings</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span>
                <span class="s">$"Cannot start application. Missing environment variables: </span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">", "</span><span class="p">,</span> <span class="n">missingSettings</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">invalidSettings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">propertyInfo</span> <span class="k">in</span> <span class="n">declaredProperties</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">configValue</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">[</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="kt">int</span><span class="p">.</span><span class="nf">TryParse</span><span class="p">(</span><span class="n">configValue</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="k">value</span><span class="p">))</span>
                    <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
                <span class="k">else</span>
                    <span class="n">invalidSettings</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
            <span class="p">}</span>  
            <span class="c1">// Parse other types required: </span>
            <span class="c1">// else if(propertyInfo.PropertyType == typeof(bool))...</span>
            <span class="c1">// else if(propertyInfo.PropertyType == typeof(Guid))...</span>
            <span class="c1">// ...</span>

            <span class="k">else</span> 
                <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">configValue</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">invalidSettings</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span>
                <span class="s">$"Cannot start application. Invalid environment variables: </span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">", "</span><span class="p">,</span> <span class="n">invalidSettings</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Guid</span> <span class="n">ApiId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">HostName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Timeout</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">SecretKey</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above code ensures that the application starts up only when its application settings are setup with the valid values and avoids anti-patterns like code duplication, usage of setting names into classes etc.</p>

  </div>

  <div class="date">
    Written on August 11, 2018
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/kiran-singh"><i class="svg-icon github"></i></a>








        </footer>
      </div>
    </div>

    

  </body>
</html>
